1. Event Loop 到底是什么样的机制？
2. 为什么 CFRunLoopRef 是线程安全的， NSRunLoop 反而线程不安全？
3. 主线程 Runloop 有什么不同吗？
4. 主线程 RunLoop 的销毁发生在什么时候？
5. RunLoop 与 Autorelease Pool 是什么关系？
6. Source0 和 Source1 事件的该如何使用
7. mach port 是什么？
8. mach_msg_trap() 做了什么
9. mode里没有source/timer/observer, 会直接返回吗？
10. 线程刚创建时并没有 RunLoop，如果你不主动获取，那它一直都不会有”，如果我一直不获取runloop的话，这个线程就不能处理事件吗？
10. 为什么在主线程添加一个 Runloop 后会卡死？（主线程加上 NSRunLoop.mainRunLoop().run() 整个程序就卡死了）
11. UI 触摸事件，到底是从 source0 还是 source1 调起的？ 
12. RunLoop 内部的逻辑图第7步，唤醒的条件port-based input source，应该是source1吧？
13. Runloop 实际应用的场景？
14. 事件响应
苹果注册了一个 Source1 (基于 mach port 的) 用来接收系统事件，其回调函数为 __IOHIDEventSystemClientQueueCallback()。但按钮的事件处理是停在__CFRunLoopDoSources0, 是Sources0而不是Source1？
15. 测试[[NSRunLoop currentRunLoop] run];NSLog(@”is running”);, 发现没有打印？


Runloop 和线程的关系？

# Event Loop

Runloop 是一个 iOS 开发里的基础概念，它并非独有的机制，很多系统和框架都有类似的实现，Runloop 是基于 Event Loop 的机制而来。
查阅 [wikipedia](https://en.wikipedia.org/wiki/Event_loop) 有关 Event Loop 的描述:
>在计算机科学里， Event Loop / Run Loop 是一个用于等待和发送消息/事件的程序结构，在程序中等待和派发一系列事件或者消息。它通过向“事件提供者”发出请求来工作，通常会阻塞请求，直到事件到达，然后调用相应的事件处理程序。

只看概念还不够具体，可以把 event loop 看作一个任务队列，可以往里面放很多的 "event (触摸事件，代码回调等)". 它是一个先进先出的结构，会一个个进出 event. 如果没有 event 就会一直循环请求，等待下一个 event.

【任务队列既不是事件的队列，也不是消息的队列。】
【任务队列就是你在主线程上的一切调用。】
【所谓的事件驱动，就是将一切抽象为事件。IO操作完成是一个事件，用户点击一次鼠标是事件，Ajax完成了是一个事件，一个图片加载完成是一个事件】
【一个任务不一定产生事件，比如获取当前时间。】
【当产生事件后，这个事件会被放进队列中，等待被处理】


【(回调函数)他们压根就没有被执行过，何来挂起之说？】
【异步任务不一定要回调函数。】
【从来就没有什么执行栈。主线程永远在执行中。主线程会不断检查事件队列】
【先产生的事件，先被处理。永远在主线程上，没有返回主线程之说】
【某些事件也不是必须要在规定的时间执行，有时候没办法在规定的时间执行】


【事件驱动的的实现过程主要靠事件循环完成。进程启动后就进入主循环。主循环的过程就是不停的从事件队列里读取事件。如果事件有关联的handle(也就是注册的callback)，就执行handle。一个事件并不一定有callback】


## 为什么要有 Event Loop ?

在很多地方都有  Event Loop 的机制，它的出现是为什么呢？

借鉴 [《JavaScript 运行机制详解：再谈Event Loop》](http://www.ruanyifeng.com/blog/2014/10/event-loop.html) 的内容，我们可以知道:[《JavaScript 运行机制详解：再谈Event Loop》](http://www.ruanyifeng.com/blog/2014/10/event-loop.html)
>在线程中的任务，都需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。而如果一些的任务很耗时，有很多 I/O 操作 或者 网络请求 的任务，那么线程就有很多时间浪费在等待 I/O操作 和 网络回调 的结果上。

类似这种情况，就需要一个 Event Loop 去专门等待 event 的结果，让线程休眠，避免浪费资源，等到事件回调，再去唤醒它。

如果没有 Event Loop 也可以工作，那我们的线程使用就会有很大的浪费和耗时。

## 异步

event loop是实现异步的一种机制。

【一般而言，操作分为：发出调用和得到结果两步。发出调用，立即得到结果是为同步。发出调用，但无法立即得到结果，需要额外的操作才能得到预期的结果是为异步。同步就是调用之后一直等待，直到返回结果。异步则是调用之后，不能直接拿到结果，通过一系列的手段才最终拿到结果（调用之后，拿到结果中间的时间可以介入其他任务）。】
【上面提到的一系列的手段其实就是实现异步的方法，其中就包括event loop。以及轮询、事件等。】
【所谓轮询：就是你在收银台付钱之后，坐到位置上不停的问服务员你的菜做好了没。】
【所谓（事件）：就是你在收银台付钱之后，你不用不停的问，饭菜做好了服务员会自己告诉你。】

# Runloop 和线程的关系

## Runloop 和线程，是一个上下的包含关系，还是并列的关系？

大部分说 Runloop 的文章，都要提到 Runloop 和线程是个一对一的关系，却没有具体解释，它是怎么对应的？是 Runloop 本身就运行在对应的线程之中嘛？还是 Runloop 是专门放在另一个线程中的？

关于 Runloop 运行的基本原理，每篇相关的文章都会上这么一段代码:

	while(!exit) {
	    //dosomthing 处理IO等等，没有事件调用系统休眠
   		 waitforEvents
	}	


就是上面这样一个简单的循环而已。

我假设 Runloop 运行在它对应的线程之中，那么就会产生一个矛盾:
>如果没有手动去退出，线程暂时也没有任务处理，Runloop 会让线程休眠。同时， Runloop 自己却是保持循环，等待接收事件进行处理。
>同一个线程，同一时间，它的状态怎么既可以运行，又可以休眠？

而 Runloop 可能运行在另一个线程中，按照 Javascript 中的 Event Loop 的实现机制， Javascript 本身是单线程操作的，不可能存在多线程。

而答案，的确是 Runloop 跟着线程一起休眠了，而信号的发出和唤醒，来自于系统。


## 观察者

【准确讲，使用事件驱动的系统中，必然有非常非常多的事件。如果事件都产生，都要主循环去处理，必然会导致主线程繁忙。那对于应用层的代码而言，肯定有很多不关心的事件（比如只关心点击事件，不关心定时器事件）。这会导致一定浪费。】
【这篇文章里没有讲到的一个重要概念是watcher。观察者。】
【事实上，不是所有的事件都放置在一个队列里。】
【不同的事件，放置在不同的队列。】
【当我们没有使用定时器时，则完全不用关心定时器事件这个队列】
【当我们进行定时器调用时，首先会设置一个定时器watcher。事件循环的过程中，会去调用该watcher，检查它的事件队列上是否产生事件（比对时间的方式）】
【当我们进行磁盘IO的时候，则首先设置一个io watcher，磁盘IO完成后，会在该io watcher的事件队列上添加一个事件。事件循环的过程中从该watcher上处理事件。处理完已有的事件后，处理下一个watcher】
【检查完所有watcher后，进入下一轮检查】
【对某类事件不关心时，则没有相关watcher】

## 协程

线程和进程这些都是操作系统调度的，现在为了优化线程切换又有用户态线程叫”协程"

效率高，一个线程中，不需要切换。

不需要使用锁，一个线程不存在同时多读多写。

## 定时器问题

但定时器事件是靠事件循环不停检查系统时间来判定是否到达时间点来产生事件】




# 主线程 Runloop

关于 Runloop 与线程的关系，是一一对应的。但是很少有人想过，主线程的 Runloop 是否可以被停止？它与子线程 Runloop 有什么不同？


## 主线程 Runloop 和 子线程 Runloop 的区别
 
 
## 主线程 Runloop 何时销毁？



# Source0 和 Source1  所接受的事件

Source1 用于接收系统事件，通过 mach_port 通信。

##  mach_port 进程通讯方式

## 一个触摸事件，是由哪个 Source 分发的？

然后这些事件又由 SpringBoard 接收，它只接收收按键(锁屏/静音等)，触摸，加速，接近传感器等几种 Event
接着用mach port转发给需要的App进程
随后苹果注册的那个 Source1 就会触发回调，并调用 _UIApplicationHandleEventQueue()进行应用内部的分发

# Runloop 不获取就不创建?

对于一些子线程的事件，没有获取 Runloop ，那这个线程就没有 Runloop 存在了吗？

# Runloop 和 AutoReleasePool 的关系



