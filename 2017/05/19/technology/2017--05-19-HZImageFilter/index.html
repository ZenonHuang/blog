<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="滤镜" />










<meta name="description" content="使用 Core Image 完成基础的滤镜功能，滤镜链，视频实时滤镜，人脸贴图">
<meta name="keywords" content="滤镜">
<meta property="og:type" content="article">
<meta property="og:title" content="CoreImage滤镜实践">
<meta property="og:url" content="https://zenonhuang.me/2017/05/19/technology/2017--05-19-HZImageFilter/index.html">
<meta property="og:site_name" content="ZenonHuang">
<meta property="og:description" content="使用 Core Image 完成基础的滤镜功能，滤镜链，视频实时滤镜，人脸贴图">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7xiym9.com1.z0.glb.clouddn.com/detectorEye.gif?imageView2/4/w/300">
<meta property="og:updated_time" content="2018-09-18T13:45:17.817Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CoreImage滤镜实践">
<meta name="twitter:description" content="使用 Core Image 完成基础的滤镜功能，滤镜链，视频实时滤镜，人脸贴图">
<meta name="twitter:image" content="http://7xiym9.com1.z0.glb.clouddn.com/detectorEye.gif?imageView2/4/w/300">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zenonhuang.me/2017/05/19/technology/2017--05-19-HZImageFilter/"/>





  <title>CoreImage滤镜实践 | ZenonHuang</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ZenonHuang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">人若无名，便可安心练剑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zenonhuang.me/2017/05/19/technology/2017--05-19-HZImageFilter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZenonHuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/author.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZenonHuang">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CoreImage滤镜实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-19T10:50:46+08:00">
                2017-05-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/19/technology/2017--05-19-HZImageFilter/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/05/19/technology/2017--05-19-HZImageFilter/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/05/19/technology/2017--05-19-HZImageFilter/" class="leancloud_visitors" data-flag-title="CoreImage滤镜实践">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          
              <div class="post-description">
                  使用 Core Image 完成基础的滤镜功能，滤镜链，视频实时滤镜，人脸贴图
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Core-Image-滤镜实践"><a href="#Core-Image-滤镜实践" class="headerlink" title="Core Image 滤镜实践"></a>Core Image 滤镜实践</h1><p><img src="http://7xiym9.com1.z0.glb.clouddn.com/detectorEye.gif?imageView2/4/w/300" alt="detecotr"></p>
<p>最近因为项目需求,接触了Core Image,实现了实时抠图,人脸贴纸。</p>
<p>决定把这次实践分享给大家,作为对开源社区的回馈。</p>
<p>相关代码上传在 <a href="https://github.com/ZernonHuang/HZImageFilter" target="_blank" rel="noopener">GitHub</a></p>
<h2 id="Core-Image-介绍"><a href="#Core-Image-介绍" class="headerlink" title="Core Image 介绍"></a>Core Image 介绍</h2><p>以下是<a href="https://developer.apple.com/library/content/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_intro/ci_intro.html" target="_blank" rel="noopener">苹果官方文档</a>给出 Core Image 的介绍：</p>
<blockquote>
<p>Core Image is an image processing and analysis technology designed to provide near real-time processing for still and video images. It operates on image data types from the Core Graphics, Core Video, and Image I/O frameworks, using either a GPU or CPU rendering path. Core Image hides the details of low-level graphics processing by providing an easy-to-use application programming interface (API). You don’t need to know the details of OpenGL, OpenGL ES, or Metal to leverage the power of the GPU, nor do you need to know anything about Grand Central Dispatch (GCD) to get the benefit of multicore processing. Core Image handles the details for you.</p>
</blockquote>
<p>翻译过来的大意是：</p>
<p>Core Image 是一个被设计用来给图片和视频提供实时的图像处理和分析技术.它可以使用 GPU 或 CPU 渲染，操作来自 Core Graphics, Core Video,以及Image I/O 框架的图片数据类型. Core Image 隐藏了底层图形处理的细节，提供简单易用的应用程序 API 接口.你不需要知道关于OpenGL, OpenGL ES,或者 Metal 的细节来利用 GPU 的能力，也不需要你知道任何关于 GCD 的知识来进行多线程处理的优化。</p>
<h3 id="CIFilter"><a href="#CIFilter" class="headerlink" title="CIFilter"></a>CIFilter</h3><p>CIFilter,是用来表示 Core Image 的各种滤镜。通过提供对应的键值对，来设置滤镜的输入参数。这些值设置好，CIFilter就可以用来生成新的CIImage输出图像。</p>
<h3 id="CIImage"><a href="#CIImage" class="headerlink" title="CIImage"></a>CIImage</h3><p> CIImage 是 Core Image 框架中最基本代表图像的对象。可以通过以下几种方式来创建 CIImage:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//通过 NSURL 创建</span><br><span class="line">CIImage*image=[CIImage imageWithContentsOfURL:myURL]; </span><br><span class="line"></span><br><span class="line">//通过 NSData 创建 </span><br><span class="line">CIImage*image=[CIImage imageWithData:myData];  </span><br><span class="line"></span><br><span class="line">//通过 CGImage 创建</span><br><span class="line">CIImage*image=[CIImage imageWithCGImage:myCgimage]; </span><br><span class="line"> </span><br><span class="line">//通过 CVPixelBuffer 创建</span><br><span class="line">CIImage*image=[CIImage imageWithCVPixelBuffer：CVBuffer];</span><br></pre></td></tr></table></figure>
<h3 id="CIContext"><a href="#CIContext" class="headerlink" title="CIContext"></a>CIContext</h3><p>所有Core Image的处理流程都通过 CIContext 来进行。</p>
<p>CIContext 可以是基于 CPU 的，也可以是基于 GPU 的，这两种渲染的区别是：</p>
<ul>
<li>CPU 渲染方式会采用 GCD 多线程来对图像进行渲染，这保证了 CPU 渲染在大部分情况下更可靠，他可以在后台实现渲染过程</li>
<li>GPU 渲染方式可以使用 OpenGLES 或者 Metal 来渲染图像，这种方式 CPU 完全无负担，应用程序的运行循环不会受到图像渲染的影响，而且他渲染比 CPU 渲染更快。缺点是 GPU 渲染无法在后台运行。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">     //创建基于 GPU 的 CIContext 对象</span><br><span class="line">     //内部的渲染器会根据设备最优选择。依次为 Metal，OpenGLES，CoreGraphics。</span><br><span class="line">CIContext *context = [CIContext contextWithOptions: nil];</span><br><span class="line"></span><br><span class="line">     //创建基于 GPU 的 CIContext 对象</span><br><span class="line">     //支持实时渲染，渲染始终在 GPU 上进行，不会复制回 CPU 存储器上，这就保证了更快的渲染速度和更好的性能。</span><br><span class="line">EAGLContext *eaglctx = [[EAGLContext alloc] initWithAPI:kEAGLRenderingAPIOpenGLES2];</span><br><span class="line">CIContext *context = [CIContext contextWithEAGLContext:eaglctx];</span><br><span class="line">        </span><br><span class="line">     //创建基于CPU的CIContext对象</span><br><span class="line">CIContext *context = [CIContext contextWithOptions:[NSDictionary dictionaryWithObject:[NSNumber numberWithBool:YES] forKey:KCIContextUseSoftWareRenderer]];</span><br></pre></td></tr></table></figure>
<p>一般采用第一种基于GPU的，因为效率要比CPU高很多.</p>
<h2 id="基础滤镜使用"><a href="#基础滤镜使用" class="headerlink" title="基础滤镜使用"></a>基础滤镜使用</h2><p>你可以这样来使用它</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//将UIImage转换成CIImage</span><br><span class="line">CIImage *ciImage = [[CIImage alloc] initWithImage:self.originImage];</span><br><span class="line"></span><br><span class="line">//创建滤镜</span><br><span class="line">CIFilter *filter = [CIFilter filterWithName:filterName </span><br><span class="line">                              keysAndValues:kCIInputImageKey,ciImage, nil];</span><br><span class="line">                              </span><br><span class="line">//已有的值不改变，其他的设为默认值</span><br><span class="line">[filter setDefaults];</span><br><span class="line"></span><br><span class="line">//创建一个CIContext对象</span><br><span class="line">CIContext *context = [CIContext contextWithOptions:nil];</span><br><span class="line"></span><br><span class="line">//滤镜渲染并输出一个CIImage</span><br><span class="line">CIImage *outputImage = [filter outputImage];</span><br><span class="line"></span><br><span class="line">//创建CGImage句柄</span><br><span class="line">CGImageRef cgImage = [context createCGImage:outputImage fromRect:[outputImage extent]];</span><br><span class="line"></span><br><span class="line">//获取图片</span><br><span class="line">UIImage *image = [UIImage imageWithCGImage:cgImage];</span><br><span class="line"></span><br><span class="line">//释放CGImage句柄</span><br><span class="line">CGImageRelease(cgImage);</span><br><span class="line"></span><br><span class="line">//得到处理后的image后赋值</span><br><span class="line">self.imageView.image = image;</span><br></pre></td></tr></table></figure>
<h2 id="滤镜链"><a href="#滤镜链" class="headerlink" title="滤镜链"></a>滤镜链</h2><p>滤镜链的使用也非常简单，将滤镜A的输出图像，当作滤镜B的输入图像，就可以把滤镜效果叠加起来。<br>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//得到要处理的图片</span><br><span class="line">CIImage *ciImage=[[CIImage alloc] initWithImage:self.originImage];</span><br><span class="line">//创建滤镜A</span><br><span class="line">CIFilter *filterA = [CIFilter filterWithName:filterNameA </span><br><span class="line">//得到滤镜A的输出图像                          keysAndValues:kCIInputImageKey,ciImage, nil];</span><br><span class="line">CIImage *ciImageA=filterA.outputImage;</span><br><span class="line">//创建滤镜B，将滤镜A的输出图像做为输入图像 </span><br><span class="line">CIFilter *filterB = [CIFilter filterWithName:filterNameB </span><br><span class="line">                                    keysAndValues:kCIInputImageKey,ciImageA, nil];</span><br><span class="line"> //得到最后的输出图像</span><br><span class="line">CIImage *ciImageB=filterB.outputImage;</span><br></pre></td></tr></table></figure>
<h2 id="实时滤镜"><a href="#实时滤镜" class="headerlink" title="实时滤镜"></a>实时滤镜</h2><p>由于视频本身是由一帧帧的图像组成的，所以我们在添加滤镜的时候，只要处理每一帧的图片就好了。</p>
<p>所以在 AVCaptureVideoDataOutputSampleBufferDelegate<br>对应的方法里做处理就ok了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">-(void)captureOutput:(AVCaptureOutput *)captureOutput didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection &#123;</span><br><span class="line">    </span><br><span class="line">    //得到要处理的图片</span><br><span class="line">    CVPixelBufferRef pixelBuffer = (CVPixelBufferRef)CMSampleBufferGetImageBuffer(sampleBuffer);</span><br><span class="line">    CIImage *image = [CIImage imageWithCVPixelBuffer:pixelBuffer];</span><br><span class="line">  </span><br><span class="line">    image=[self inputCIImageForDetector:image];</span><br><span class="line">    </span><br><span class="line">     /** 使用 CISourceOverCompositing 滤镜，制定前后的图片关系，可以把两张图片组合**/</span><br><span class="line">    CIImage *resulImage = [[CIFilter filterWithName:@&quot;CISourceOverCompositing&quot; </span><br><span class="line">                                      keysAndValues:kCIInputImageKey,image,kCIInputBackgroundImageKey,self.bgImage,nil] </span><br><span class="line">                           valueForKey:kCIOutputImageKey];</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    [self.glkView bindDrawable];</span><br><span class="line">    if( !(self.glContext == [EAGLContext currentContext])) &#123;</span><br><span class="line">        [EAGLContext setCurrentContext:self.glContext];</span><br><span class="line">    &#125;</span><br><span class="line">    // clear eagl view to grey</span><br><span class="line">    glClearColor(0.5, 0.5, 0.5, 1.0); </span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line">    </span><br><span class="line">    // set the blend mode to &quot;source over&quot; so that CI will use that</span><br><span class="line">    glEnable(GL_BLEND);  </span><br><span class="line">    glBlendFunc(GL_ONE, GL_ONE_MINUS_SRC_ALPHA);</span><br><span class="line">    [self.ciContext drawImage:resulImage</span><br><span class="line">                       inRect:CGRectMake(0, 0, ScreenWidth*2, ScreenHeight*2) </span><br><span class="line">                     fromRect:CGRectMake(0, 0, [image extent].size.width,[image extent].size.height) ];</span><br><span class="line">    [self.glkView display];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="人脸检测"><a href="#人脸检测" class="headerlink" title="人脸检测"></a>人脸检测</h2><p>Core Image 已经提供了 CIDetector 来做特征检测，里面包含了 CIDetectorTypeFace 的特征类型来做人脸识别。并且它已被优化过，使用起来也很容易。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//创建一个CIDetector对象</span><br><span class="line">CIDetector *faceDetector = [CIDetector detectorOfType:CIDetectorTypeFace context:context options:@&#123;CIDetectorAccuracy: CIDetectorAccuracyHigh&#125;];</span><br><span class="line">//给出要识别的图片，得到一个人脸结果的数组</span><br><span class="line">NSArray *faces = [faceDetector featuresInImage:image];</span><br></pre></td></tr></table></figure>
<p>数组 faces 中保存着 CIFaceFeature 类的实例。通过CIFaceFeature 的实例，不仅可以得到脸部的位置信息，也可以知道眼睛和嘴巴的位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">for (CIFeature *f in faces)&#123;</span><br><span class="line">        CIFaceFeature *faceFeature=(CIFaceFeature *)f;</span><br><span class="line">        // 判断是否有左眼位置</span><br><span class="line">        if(faceFeature.hasLeftEyePosition)&#123;</span><br><span class="line">              </span><br><span class="line">        &#125;</span><br><span class="line">        // 判断是否有右眼位置</span><br><span class="line">        if(faceFeature.hasRightEyePosition)&#123;</span><br><span class="line">       </span><br><span class="line">        &#125;</span><br><span class="line">        // 判断是否有嘴位置</span><br><span class="line">        if(faceFeature.hasMouthPosition)&#123;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">                    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里需要注意的是，Core Image 和 UIKit 使用了不同的坐标系: Core Image 是以左下角作为原点，UIKit 是以左上角为原点。需要用 仿射变换 将 Core Image 坐标转换成了 UIKit 坐标。</p>
<p>参考资料:</p>
<p><a href="https://developer.apple.com/library/content/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_intro/ci_intro.html#//apple_ref/doc/uid/TP30001185" target="_blank" rel="noopener">Core Image Programming Guide</a></p>
<p><a href="http://swift.gg/2017/05/11/face-detection-core-image/" target="_blank" rel="noopener">在iOS上用 Core Image 实现人脸检测</a></p>
<p><a href="http://colin1994.github.io/2016/10/21/Core-Image-OverView/" target="_blank" rel="noopener">Core Image 你需要了解的那些事~</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/资料/" rel="tag"># 资料</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/15/technology/2017-05-15-SemaphoresinSwift/" rel="next" title="(轉)Swift 中的信號量">
                <i class="fa fa-chevron-left"></i> (轉)Swift 中的信號量
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/05/23/technology/2017-05-23-MMPopupVIew/" rel="prev" title="MMPopupView 源码阅读">
                MMPopupView 源码阅读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2112728" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/author.jpg"
                alt="ZenonHuang" />
            
              <p class="site-author-name" itemprop="name">ZenonHuang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Core-Image-滤镜实践"><span class="nav-number">1.</span> <span class="nav-text">Core Image 滤镜实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Core-Image-介绍"><span class="nav-number">1.1.</span> <span class="nav-text">Core Image 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CIFilter"><span class="nav-number">1.1.1.</span> <span class="nav-text">CIFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CIImage"><span class="nav-number">1.1.2.</span> <span class="nav-text">CIImage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CIContext"><span class="nav-number">1.1.3.</span> <span class="nav-text">CIContext</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基础滤镜使用"><span class="nav-number">1.2.</span> <span class="nav-text">基础滤镜使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#滤镜链"><span class="nav-number">1.3.</span> <span class="nav-text">滤镜链</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实时滤镜"><span class="nav-number">1.4.</span> <span class="nav-text">实时滤镜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#人脸检测"><span class="nav-number">1.5.</span> <span class="nav-text">人脸检测</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZenonHuang</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zenonhuang.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://zenonhuang.me/2017/05/19/technology/2017--05-19-HZImageFilter/';
          this.page.identifier = '2017/05/19/technology/2017--05-19-HZImageFilter/';
          this.page.title = 'CoreImage滤镜实践';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zenonhuang.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("k2TRBWba0l1Gs8oDHKfxxSXD-gzGzoHsz", "lb4xG7itO28IvwoxTwydiiJC");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
